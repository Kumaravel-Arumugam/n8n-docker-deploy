services:

  postgres:
    image: timescale/timescaledb:latest-pg16
    container_name: postgres_db
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_MAX_CONNECTIONS: "100"
    volumes:
      - ./database_postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G

  n8n:
    image: n8nio/n8n:2.5.2
    container_name: n8n
    restart: unless-stopped
    ports:
      - "1017:5678"
      - "5679:5679"
    volumes:
      - ./n8n_data_postgres:/home/node/.n8n
    # Load the .env file globally for this container
    env_file:
      - .env
    environment:
      # Database - Uses variables from .env
      DB_TYPE: "postgresdb"
      DB_POSTGRESDB_HOST: "postgres"
      DB_POSTGRESDB_PORT: "5432"
      DB_POSTGRESDB_DATABASE: "${POSTGRES_DB}"
      DB_POSTGRESDB_USER: "${POSTGRES_USER}"
      DB_POSTGRESDB_PASSWORD: "${POSTGRES_PASSWORD}"
      
      # Performance
      NODE_OPTIONS: "--max-old-space-size=4096"
      EXECUTIONS_DATA_PRUNE: "true"
      EXECUTIONS_DATA_MAX_AGE: "168"
      N8N_EXECUTIONS_DATA_SAVE_ON_SUCCESS: "false"
      N8N_EXECUTIONS_DATA_SAVE_ON_ERROR: "all"
      N8N_DEFAULT_BINARY_DATA_MODE: "filesystem"
      N8N_COMMUNITY_PACKAGES_ENABLED: "true"
      
      # URLs - Uses variables from .env
      N8N_EDITOR_BASE_URL: "${N8N_EDITOR_BASE_URL}"
      WEBHOOK_URL: "${WEBHOOK_URL}"
      
      # Task Runners
      N8N_RUNNERS_ENABLED: "true"
      N8N_RUNNERS_MODE: "external"
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: "0.0.0.0"
      N8N_RUNNERS_AUTH_TOKEN: "${N8N_RUNNERS_AUTH_TOKEN}"
      N8N_CODE_NODE_DEFAULT_RUNTIME: "python"
      N8N_RUNNERS_ACCEPTED_TASK_RUNNER_NAMES: "task-runner-python,launcher-python"

      
      # Misc
      N8N_FOLDERS_ENABLED: "true"
      # IMPORTANT: This must be false to use variables in nodes
      N8N_BLOCK_ENV_ACCESS_IN_NODE: "false" 
      N8N_ALLOW_ENV_VARIABLES: "true"
      N8N_ENV_ALLOWLIST: "TELEGRAM_BOT_TOKEN,ANGELONE_PRIVATE_KEY,ANGELONE_CLIENT_CODE,ANGELONE_PASSWORD"
      GENERIC_TIMEZONE: "Asia/Kolkata"
      N8N_DIAGNOSTICS_ENABLED: "false"
      N8N_VERSION_NOTIFICATIONS_ENABLED: "false"
      N8N_TEMPLATES_ENABLED: "false"
      N8N_PERSONALIZATION_ENABLED: "false"

    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      ollama:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 3G


  selenium:
     image: selenium/standalone-chrome:latest
     container_name: selenium
     restart: unless-stopped
     shm_size: "2gb"
     ports:
       - "4444:4444"
     deploy:
       resources:
         limits:
           memory: 2G


  task-runners:
    build:
      context: .
      dockerfile: Dockerfile.runners
    container_name: task-runners
    restart: unless-stopped
    ports:  # ADD THIS BLOCK
      - "5680:5680"
      - "5681:5681"
      - "5682:5682"
    env_file:
      - .env
    environment:
      # Connection settings
      N8N_RUNNERS_AUTH_TOKEN: "${N8N_RUNNERS_AUTH_TOKEN}"
      N8N_RUNNERS_TASK_BROKER_URI: "http://n8n:5679"
      N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT: "60"
      
      SELENIUM_REMOTE_URL: "http://selenium:4444/wd/hub"
      
      # Python allowlists
      N8N_RUNNERS_STDLIB_ALLOW: "json,math,re,datetime,random,collections,itertools,io,base64,sys,os,time,pickle,tempfile"
      N8N_RUNNERS_EXTERNAL_ALLOW: "numpy,pandas,matplotlib,mplfinance,mplcyberpunk,requests,beautifulsoup4,selenium,webdriver-manager,tqdm,openpyxl,fpdf"
      # JavaScript allowlists
      NODE_FUNCTION_ALLOW_BUILTIN: "crypto"
      NODE_FUNCTION_ALLOW_EXTERNAL: "moment,uuid"
      
      GENERIC_TIMEZONE: "Asia/Kolkata"
    depends_on:
      - n8n
    deploy:
      resources:
        limits:
          memory: 2G

  # ... (Ollama and Qdrant services remain unchanged) ...
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OLLAMA_NUM_PARALLEL=1
      - OLLAMA_KEEP_ALIVE=5m
      - OLLAMA_FLASH_ATTENTION=1
      - OLLAMA_KV_CACHE_TYPE=q4
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  qdrant:
    image: qdrant/qdrant
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 2G




# NO named volumes - everything in D:\docker folders

# netsh int ipv4 reset
# netsh advfirewall reset
# the above two commands are to reset firewall and network settings in windows if there are issues with docker networking ports...


#docker compose down
#docker compose build --no-cache
#docker compose up -d


# ===== HOW TO ADD A NEW SECRET / VARIABLE (REFERENCE) =====
# Example: TESTING_KEY = 1 2 3 4 5 6 7 8 9 10
#
# 1) Add the variable to .env
#    TESTING_KEY=12345678910
#
# 2) Add the variable name to N8N_ENV_ALLOWLIST
#    N8N_ENV_ALLOWLIST: "TELEGRAM_BOT_TOKEN,ANGELONE_PRIVATE_KEY,ANGELONE_CLIENT_CODE,ANGELONE_PASSWORD,TESTING_KEY"
#
# 3) Do NOT hardcode the value in any node
#
# 4) Use it only via Expression,not fixed:
#    {{$env.TESTING_KEY}}
#    (or via Code node: process.env.TESTING_KEY)
#
# 5) Save + Activate the workflow
#
# 6) Recreate containers if docker-compose was changed:
#    docker compose down
#    docker compose up -d --build
#
# =========================================================
